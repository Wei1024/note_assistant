<script setup lang="ts">
import { ref } from 'vue'
import { useNoteCapture } from '@/composables/useNoteCapture'
import { useToast } from '@/composables/useToast'
import Button from '@/components/shared/Button.vue'
import { colors } from '@/design/colors'
import { typography } from '@/design/typography'
import { spacing, borderRadius } from '@/design/spacing'

const noteText = ref('')
const { isLoading, error, capture } = useNoteCapture()
const { success, info } = useToast()

const handleSave = async () => {
  const text = noteText.value

  const result = await capture(text, (_noteId, title) => {
    // Called when background classification completes
    success(`✨ Classification complete: "${title}"`, 5000)
  })

  if (result) {
    // Show immediate success
    success(`✓ Note saved: "${result.title}"`)

    // Clear textarea immediately for next note
    noteText.value = ''

    // Show info about background processing
    setTimeout(() => {
      info('⏳ Adding dimensions and tags...', 4000)
    }, 500)
  }
}

// Keyboard shortcut: Cmd/Ctrl+Enter to save
const handleKeydown = (event: KeyboardEvent) => {
  if ((event.metaKey || event.ctrlKey) && event.key === 'Enter') {
    event.preventDefault()
    handleSave()
  }
}
</script>

<template>
  <div class="capture-view">
    <div class="capture-view__header">
      <h2 :style="{ fontSize: typography.fontSize['2xl'], fontWeight: typography.fontWeight.semibold }">
        Capture Your Thoughts
      </h2>
      <p :style="{ color: colors.text.muted, fontSize: typography.fontSize.base }">
        Write naturally. Notes are saved instantly and enriched with AI-powered classification.
      </p>
    </div>

    <div class="capture-view__content">
      <!-- Textarea - never disabled, always ready -->
      <textarea
        v-model="noteText"
        placeholder="Type your note here... Meeting notes, ideas, tasks, or anything else on your mind.

Tip: Press Cmd+Enter (Mac) or Ctrl+Enter (Windows) to save quickly."
        class="capture-textarea"
        :style="textareaStyle as any"
        @keydown="handleKeydown"
        autofocus
      />

      <!-- Action button -->
      <div class="capture-actions">
        <Button
          variant="primary"
          size="lg"
          icon="note"
          :loading="isLoading"
          :disabled="!noteText.trim()"
          @click="handleSave"
        >
          Save Note
        </Button>

        <span
          v-if="noteText.trim()"
          :style="{
            fontSize: typography.fontSize.sm,
            color: colors.text.muted,
            alignSelf: 'center'
          }"
        >
          or press ⌘+Enter
        </span>
      </div>

      <!-- Error message -->
      <div
        v-if="error"
        class="capture-status capture-status--error"
        :style="statusErrorStyle"
      >
        ✗ {{ error }}
      </div>

      <!-- Info message -->
      <div
        v-if="!error"
        :style="{
          marginTop: spacing[4],
          fontSize: typography.fontSize.sm,
          color: colors.text.muted
        }"
      >
        💡 Your notes are automatically enriched with dimensions, tags, and metadata.
        View classification results in the Search view.
      </div>
    </div>
  </div>
</template>

<script lang="ts">
const textareaStyle = {
  width: '100%',
  minHeight: '400px',
  padding: spacing[4],
  fontSize: typography.fontSize.base,
  fontFamily: typography.fontFamily.sans,
  lineHeight: typography.lineHeight.relaxed,
  backgroundColor: colors.background.card,
  color: colors.text.primary,
  border: `1px solid ${colors.border.default}`,
  borderRadius: borderRadius.lg,
  resize: 'vertical' as const,
  transition: 'all 200ms ease',
}

const statusErrorStyle = {
  padding: spacing[4],
  backgroundColor: colors.status.error + '15',
  color: colors.status.error,
  border: `1px solid ${colors.status.error}`,
  borderRadius: borderRadius.lg,
  marginTop: spacing[4],
}
</script>

<style scoped>
.capture-view {
  max-width: 900px;
  margin: 0 auto;
}

.capture-view__header {
  margin-bottom: v-bind('spacing[8]');
}

.capture-view__header p {
  margin-top: v-bind('spacing[2]');
}

.capture-view__content {
  display: flex;
  flex-direction: column;
}

.capture-textarea:focus {
  outline: none;
  border-color: v-bind('colors.accent.primary');
  box-shadow: 0 0 0 3px rgba(212, 122, 68, 0.1);
}

.capture-actions {
  display: flex;
  gap: v-bind('spacing[4]');
  align-items: center;
  margin-top: v-bind('spacing[4]');
}

.capture-status {
  animation: slideIn 200ms ease;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
</style>
